Transform: AWS::Serverless-2016-10-31
Globals:
  Function:
    Tags:
      app: aws-bedrock-telegram-genai-chatbot
    Runtime: python3.13
    Architectures:
    - arm64
    LoggingConfig:
      LogGroup:
        Fn::Sub: /aws/lambda/${AWS::StackName}
      LogFormat: JSON
    Layers:
    - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension-Arm64:20
    - Fn::Sub: arn:aws:lambda:${AWS::Region}:615299751070:layer:AWSOpenTelemetryDistroPython:5
    Tracing: Active
    Environment:
      Variables:
        AWS_LAMBDA_EXEC_WRAPPER: /opt/otel-instrument
Resources:
  TelegramFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description:
        Fn::Sub:
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: TelegramFunction
      CodeUri: TelegramFunction
      Handler: bot.lambda_handler
      MemorySize: 256
      Timeout: 30
      AutoPublishAlias: SnapStart
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - Statement:
        - Effect: Allow
          Action:
          - ssm:GetParameter
          Resource:
          - arn:aws:ssm:*:*:parameter/bedrock-telegram-genai-chatbot/*
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          Resource: '*'
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ChatHistory
      Events:
        ApiPOST:
          Type: Api
          Properties:
            Path: /
            Method: POST
      Environment:
        Variables:
          CHATHISTORY_TABLE_NAME:
            Ref: ChatHistory
          CHATHISTORY_TABLE_ARN:
            Fn::GetAtt:
            - ChatHistory
            - Arn
    Metadata:
      SamResourceId: TelegramFunction
  TelegramFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Retain
  ChatHistory:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: chat_id
        AttributeType: S
      - AttributeName: timestamp
        AttributeType: S
      KeySchema:
      - AttributeName: chat_id
        KeyType: HASH
      - AttributeName: timestamp
        KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: expireat
        Enabled: true
      Tags:
      - Value: aws-bedrock-telegram-genai-chatbot
        Key: app
